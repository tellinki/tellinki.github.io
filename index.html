<script>
    // Initialize the map with Leaflet
    var map = L.map('map', { minZoom: 10, maxZoom: 20 });

    // Center the map to show Helsinki well
    map.setView([60.2097412, 24.98643], 11);

    // Set the map view bounds (Desktop size)
    map.setMaxBounds(L.latLngBounds(L.latLng(60.3300069, 25.5136872), L.latLng(60.0888172, 24.4589996)));

    // Set the desired tiles with attribution
    L.tileLayer.provider('CartoDB.VoyagerLabelsUnder').addTo(map);

    // Allow asking for the user's current location
    L.control.locate().addTo(map);

    // Add info text
    L.Control.Textbox = L.Control.extend({
        onAdd: function(map) {
            var text = L.DomUtil.create('div', 'info-text');
            text.id = "info_text";
            text.innerHTML = "<strong>Aineisto päivitetty 02.09.2024. Lisätty pyöräkorjaus- ja vesipisteet. Ylläpitäjä Tommi Hautala (palaute@tellinki.com), aineistoa voi muokata OpenStreetMapin kautta.</strong>";
            return text;
        },
        onRemove: function(map) {}
    });
    L.control.textbox = function(opts) {
        return new L.Control.Textbox(opts);
    };
    L.control.textbox({ position: 'bottomleft' }).addTo(map);

    // Add custom icons for markers
    var rackIcon = L.icon({ iconUrl: 'images/icons/icon-rack.png', iconSize: [32, 32] });
    var standIcon = L.icon({ iconUrl: 'images/icons/icon-stand.png', iconSize: [32, 32] });
    var twotierIcon = L.icon({ iconUrl: 'images/icons/icon-twotier.png', iconSize: [32, 32] });
    var safeloopIcon = L.icon({ iconUrl: 'images/icons/icon-safeloop.png', iconSize: [32, 32] });
    var mechIcon = L.icon({ iconUrl: 'images/icons/icon-mech.png', iconSize: [16, 16] });
    var waterIcon = L.icon({ iconUrl: 'images/icons/icon-water.png', iconSize: [16, 16] });

    // Create layers for GeoJSON data
    var mechLayer = L.geoJSON(null);
    var waterLayer = L.geoJSON(null);
    var baanatLayer = L.geoJSON(null);
    var parkingLayer = L.markerClusterGroup({
        maxClusterRadius: 200,
        disableClusteringAtZoom: 17,
        spiderfy_on_max_zoom: false
    });

    // Fetch mechanical repair points
    fetch('/mech.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    var lat = feature.properties.lat;
                    var lon = feature.properties.lon;
                    var latLng = L.latLng(lat, lon);
                    var marker = L.marker(latLng, { icon: mechIcon });

                    var popupContent = `<b>Palvelut:</b> <br>`;
                    var services = {
                        "service:bicycle:chain_tool": "Ketjutyökalu",
                        "service:bicycle:cleaning": "Pesupaikka",
                        "service:bicycle:diy": "Työkalut",
                        "service:bicycle:pump": "Pumppu",
                        "service:bicycle:screwdriver": "Ruuvimeisseli",
                        "service:bicycle:stand": "Teline",
                        "service:bicycle:tools": "Työkalut"
                    };
                    for (var service in services) {
                        if (feature.properties[service] === "yes") {
                            popupContent += `✔ ${services[service]} saatavilla<br>`;
                        }
                    }
                    marker.bindPopup(popupContent);
                    return marker;
                }
            }).addTo(mechLayer);
            map.addLayer(mechLayer); // Add layer to map
        })
        .catch(error => console.error('Error loading the GeoJSON file:', error));

    // Fetch water points
    fetch('/water.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    var lat = feature.properties.lat;
                    var lon = feature.properties.lon;
                    var latLng = L.latLng(lat, lon);
                    var marker = L.marker(latLng, { icon: waterIcon });
                    return marker;
                }
            }).addTo(waterLayer);
            map.addLayer(waterLayer); // Add layer to map
        })
        .catch(error => console.error('Error loading the GeoJSON file:', error));

    // Fetch GeoJSON baana data and add it to the map
    fetch('/baanat.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                filter: function(feature) {
                    return feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString';
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(feature.properties.name);
                    }
                }
            }).addTo(baanatLayer);
            map.addLayer(baanatLayer); // Add layer to map
        })
        .catch(error => console.error('Error loading the GeoJSON data:', error));

    // Fetch parking information from the json
    fetch('/parking.json')
        .then(response => response.json())
        .then(json => {
            json['features'].forEach(item => {
                var amenity = item['properties']['bicycle_parking'];
                if (amenity == null || !['stands', 'safe_loops', 'two-tier', 'rack'].includes(amenity)) return;

                var icon;
                if (amenity === 'stands') {
                    icon = standIcon;
                } else if (amenity === 'rack') {
                    icon = rackIcon;
                } else if (amenity === 'safe_loops') {
                    icon = safeloopIcon;
                } else if (amenity === 'two-tier') {
                    icon = twotierIcon;
                }

                var mark = L.marker([item['properties']['lat'], item['properties']['lon']], { icon: icon });
                var capacity = item['properties']['capacity'];
                if (capacity) {
                    mark.bindTooltip(capacity, { permanent: true, direction: 'right', className: 'marker-label' });
                }
                parkingLayer.addLayer(mark);
            });
            map.addLayer(parkingLayer); // Add layer to map
        })
        .catch(error => console.error('Error fetching the GeoJSON:', error));

    // Add layer control
    var overlays = {
        "Huoltopisteet": mechLayer,
        "Vesipisteet": waterLayer,
        "Baanat": baanatLayer,
        "Runkolukittavat telineet": parkingLayer
    };
    L.control.layers(null, overlays).addTo(map);

    // Register service worker to allow installing as app
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
    }
</script>
