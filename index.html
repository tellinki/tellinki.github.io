<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="Sun, 25 August 2024 14:00:00 GMT" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="Expires" content="600" />
    
    <title>Tellinki.com</title>
    <meta name="description" content="Tellinki.com - Runkolukittavat pyörätelineet pääkaupunkiseudulla">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0050aa">
    <link rel="manifest" href="manifest.json">
    
    <!-- Android, iOS, MS, and Favicon links for app/web capabilities -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="images/icons/icon-192x192.png">
    <link rel="icon" sizes="512x512" href="images/icons/icon-512x512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Tellinki.com">
    <link rel="apple-touch-icon-precomposed" href="images/icons/icon-512x512.png">
    <link rel="mask-icon" href="images/icons/desktop/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="msapplication-TileImage" content="images/icons/icon-150x150.png">
    <meta name="msapplication-TileColor" content="#0050aa">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icons/icon-16x16.png">
    
    <!-- Leaflet styles -->
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="css/L.Control.Locate.min.css">
    
    <style>
        /* Map container styling */
        #map {
            height: 100vh;
            width: 100vw;
        }

        /* Custom marker cluster styles */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background-color: rgba(0, 80, 170, 0.2);
        }
        .marker-cluster-small div,
        .marker-cluster-medium div,
        .marker-cluster-large div {
            color: #FFF;
            background-color: #0050aa;
        }

        /* Tooltip and marker label styles */
        .leaflet-tooltip.marker-label {
            top: -16px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin: 0px;
            padding: 4px;
            line-height: 1.8;
            color: #0050aa;
            background-color: #FFF;
        }

        /* Road shield style for reference number */
        .road-shield {
            background: #fcb919;
            border: 2px solid black;
            color: black;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            line-height: 20px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
    
    <!-- Leaflet scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="js/leaflet-providers.min.js"></script>
    <script src="js/L.Control.Locate.min.js"></script>
</head>

<body>
    <main>
        <div id="map"></div>
    </main>
    <noscript>Turn on JavaScript to access this site content.</noscript>

    <script>
        // Initialize the map
        const map = L.map('map', { minZoom: 12, maxZoom: 18 });
        map.setView([60.2097412, 24.98643], 10); // Center map over Helsinki
        map.setMaxBounds(L.latLngBounds(L.latLng(60.3300069, 25.5136872), L.latLng(60.0888172, 24.4589996)));

        // Add OpenStreetMap tile layer
        L.tileLayer.provider('OpenStreetMap.DE').addTo(map);

        // Add location control (shows user's location)
        L.control.locate().addTo(map);

        // Add info text at the bottom left
        L.Control.Textbox = L.Control.extend({
            onAdd: function(map) {
                const text = L.DomUtil.create('div', 'info-text');
                text.id = "info_text";
                text.innerHTML = "<strong>Aineisto päivitetty 15.02.2025...</strong>";
                return text;
            },
            onRemove: function(map) {}
        });
        L.control.textbox({ position: 'bottomleft' }).addTo(map);

        // Define custom marker icons for different types of parking
        const rackIcon = L.icon({ iconUrl: 'images/icons/icon-rack.png', iconSize: [32, 32] });
        const standIcon = L.icon({ iconUrl: 'images/icons/icon-stand.png', iconSize: [32, 32] });
        const twotierIcon = L.icon({ iconUrl: 'images/icons/icon-twotier.png', iconSize: [32, 32] });
        const safeloopIcon = L.icon({ iconUrl: 'images/icons/icon-safeloop.png', iconSize: [32, 32] });

        // Fetch and display mechanical repair points
        fetch('/mech.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        const marker = L.marker(latlng, { icon: mechIcon });
                        let popupContent = `<b>Palvelut:</b><br>`;
                        const services = {
                            "service:bicycle:chain_tool": "Ketjutyökalu",
                            "service:bicycle:cleaning": "Pesupaikka",
                            "service:bicycle:diy": "Työkalut",
                            "service:bicycle:pump": "Pumppu",
                            "service:bicycle:screwdriver": "Ruuvimeisseli",
                            "service:bicycle:stand": "Teline",
                            "service:bicycle:tools": "Työkalut"
                        };
                        // Loop through and add available services to popup
                        for (const service in services) {
                            if (feature.properties[service] === "yes") {
                                popupContent += `✔ ${services[service]} saatavilla<br>`;
                            }
                        }
                        marker.bindPopup(popupContent);
                        return marker;
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading the GeoJSON file:', error));

        // Fetch and display water points
        fetch('/water.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        const marker = L.marker(latlng, { icon: waterIcon });
                        return marker;
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading the GeoJSON file:', error));

        // Fetch and display baana-lines
        fetch('/baanat.geojson')
            .then(response => response.json())
            .then(data => {
                const geojsonLayer = L.geoJSON(data, {
                    filter: function(feature) {
                        return feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString';
                    },
                    style: function(feature) {
                        return {
                            color: "#a952ce",
                            weight: getLineWidth(map.getZoom()),
                            opacity: 1
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties.name) {
                            layer.bindTooltip(feature.properties.name, {
                                permanent: false,
                                direction: "center",
                                className: "line-tooltip"
                            });
                        }
                        if (feature.properties.ref) {
                            const midpoint = getLineMidpoint(feature.geometry.coordinates);
                            if (midpoint) {
                                const icon = L.divIcon({
                                    className: 'road-icon',
                                    html: `<div class="road-shield">${feature.properties.ref}</div>`,
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                });
                                L.marker([midpoint[1], midpoint[0]], { icon }).addTo(map);
                            }
                        }
                    }
                }).addTo(map);

                // Adjust line weight based on zoom level
                map.on('zoomend', function() {
                    const zoom = map.getZoom();
                    geojsonLayer.setStyle({ weight: getLineWidth(zoom) });
                });
            })
            .catch(error => {
                console.error('Error loading the GeoJSON data:', error);
            });

        // Utility function to get midpoint of coordinates
        function getLineMidpoint(coords) {
            if (!coords.length) return null;
            const midIndex = Math.floor(coords.length / 2);
            return coords[midIndex];
        }

        // Adjust line width based on zoom level
        function getLineWidth(zoom) {
            if (zoom >= 15) return 6;
            if (zoom >= 12) return 4;
            if (zoom >= 10) return 2;
            return 2;
        }

        // Register service worker for app installation
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
    </script>
</body>

</html>
